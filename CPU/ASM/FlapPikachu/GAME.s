;R0 KEYBOARD
;R1 ROW
;R2 COL
;R3 Character row
;R4 Scene start addr
;R5 COUNTER
;R6 ADDR
;R7 

;RAM1
;3000-5000 scene
;5001 score
;5002-5003 clouds 

;障碍 宽10
;皮卡 宽8 高4
;皮卡横坐标 20 初始纵坐标 11


NOP
NOP
NOP

REAL_INIT:
	LI R1 0X0000
	LI R0 0X0000
	REAL_ROW_LOOP:
	CMPI R1 0X001E
	NOP
	BTEQZ INIT
	NOP
	LI R2 0X0000
		REAL_COL_LOOP:
		CMPI R2 0X0050
		NOP
		BTEQZ REAL_COL_END
		NOP
		SLL R7 R1 0X0000
		OR R7 R2
		LI R6 0X00BF
		SLL R6 R6 0X0000
		ADDIU R6 0X000A
		SW R6 R7 0X0000
		SW R6 R0 0X0003
		ADDIU R2 0X0001
		NOP
		B REAL_COL_LOOP
		NOP
	REAL_COL_END:
	ADDIU R1 0X0001
	NOP
	B REAL_ROW_LOOP
	NOP

INIT:  ;显示初始图片

LI R5 0X0000
LI R1 0X000A ;row
LI R0 0X0000 ;gpu data	
	
	INIT_ROW_LOOP:
	LI R2 0X001E ;col
	
		INIT_COL_LOOP:
		SLL R7 R1 0X0000 ;pos row
		OR R7 R2 ;pos
		LI R6 0X00BF
		SLL R6 R6 0X0000
		ADDIU R6 0X000A
		SW R6 R7 0X0000
		
		LI R6 0X00BF ;gpu data
		SLL R6 R6 0X0000
		ADDIU R6 0X000D
		SW R6 R0 0X0000
		
		ADDIU R0 0X0001
		ADDIU R2 0X0001
		CMPI R2 0X0032
		BTEQZ INIT_COL_END
		NOP
		B INIT_COL_LOOP
		NOP
		
	INIT_COL_END:
	NOP
	ADDIU R1 0X0001
	CMPI R1 0X0014
	BTEQZ INIT_KEY
	NOP
	B INIT_ROW_LOOP
	NOP
	
REAL_INIT_PRE2:
	NOP
	B REAL_INIT
	NOP
	
INIT_KEY:
LI R6 0X00BF
SLL R6 R6 0X0000
ADDIU R6 0X000E
	INIT_KEY_GET:
		LW R6 R0 0X0000
		CMPI R0 0X0020
		BTEQZ START
		NOP
		B INIT_KEY_GET
		NOP
				
		
START:
	
	LI R4 0X0030 
	SLL R4 R4 0X0000 ;scene start addr
	LI R3 0X000B ;皮卡丘纵坐标
	

	LI R1 0X0000 ;背景
	LI R0 0X0000
	
		BACK_ROW:
		LI R2 0X0000
		
			BACK_COL_LOOP:
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			NOP
			SW R6 R0 0X0003
			
			ADDIU R2 0X0001
			CMPI R2 0X0050
			BTEQZ BACK_COL_END
			NOP
			B BACK_COL_LOOP
			NOP
			
		BACK_COL_END:
		NOP
		ADDIU R1 0X0001
		CMPI R1 0X001E
		BTEQZ BASE_LOOP
		NOP
		B BACK_ROW
		NOP
		
REAL_INIT_PRE1:
	NOP
	B REAL_INIT_PRE2
	NOP
		
BASE_LOOP:
	
	NOP	
		
	GET_KEY:
	LI R6 0X00BF
	SLL R6 R6 0X0000
	ADDIU R6 0X000E
	LW R6 R0 0X0000
	CMPI R0 0X0020
	LI R5 0X0004
	NOP
	BTEQZ PIKA_UPPRE1
	NOP

	LOOP_FIN:
	LI R6 0X0020
	SLL R6 R6 0X0000
	LW R6 R5 0X0000
	LI R6 0X003F
	SLL R6 R6 0X0000
	ADDIU R6 0X00FF
	AND R6 R5
	BEQZ R6 SCENE_MOVE
	NOP

	FINISH_MOVE:
	LI R6 0X003F
	SLL R6 R6 0X0000
	ADDIU R6 0X00FF
	AND R6 R5
	BEQZ R6 PIKA_DOWNPRE1
	NOP

	FINISH_DOWN:
	ADDIU R5 0X0001
	LI R6 0X0020
	SLL R6 R6 0X0000
	SW R6 R5 0X0000
	
	CHECK:
	CMPI R3 0X0000
	BTEQZ REAL_INIT_PRE1
	NOP
	CMPI R3 0X001B
	BTEQZ REAL_INIT_PRE1
	NOP
	
	LI R2 0X0014	
		CHECK_COL_LOOP:
		CMPI R2 0X001C
		NOP
		BTEQZ CHECK_END
		NOP
		ADDU R2 R4 R7
		LW R7 R0 0X0000
		SRA R0 R0 0X0000
		LI R6 0X00FF
		AND R0 R6
		ADDIU R0 0XFFFE
		SLTU R0 R3
		BTEQZ REAL_INIT_PRE1
		NOP
		LW R7 R0 0X0000
		LI R6 0X00FF
		AND R0 R6
		ADDIU R0 0X00FC
		ADDIU R0 0X0002
		SLTU R3 R0
		BTEQZ REAL_INIT_PRE1
		NOP
		ADDIU R2 0X0001
		NOP
		B CHECK_COL_LOOP
		NOP
	
	CHECK_END:
	NOP
	B BASE_LOOP
	NOP
	
	
SCENE_END: ;重绘制PIKA
	MTIH R3 ;储存R3
	ADDIU3 R3 R1 0X0000	
	ADDIU R3 0X0004 ;
	LI R0 0X00C8 ;PIKA Data start
	
	PIKA_PAINT_ROW_LOOP:
		CMP R1 R3
		NOP
		BTEQZ PIKA_PAINT_ROW_END
		NOP
		LI R2 0X0014
			
			PIKA_PAINT_COL_LOOP:
			CMPI R2 0X001C
			NOP
			BTEQZ PIKA_PAINT_COL_END
			
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			NOP
			SW R6 R0 0X0003
			
			ADDIU R0 0X0001
			ADDIU R2 0X0001
			NOP
			B PIKA_PAINT_COL_LOOP
			NOP
			
		PIKA_PAINT_COL_END:
		ADDIU R1 0X0001
		NOP
		B PIKA_PAINT_ROW_LOOP
		NOP
		
	PIKA_PAINT_ROW_END:
	MFIH R3 ;恢复R3
	NOP
	B FINISH_MOVE
	NOP
		
PIKA_DOWN_END:	
	NOP
	B FINISH_DOWN
	NOP

PIKA_DOWNPRE1:
	NOP
	B PIKA_DOWNPRE2
	NOP
	
PIKA_UP_END:	
	ADDIU R5 0XFFFF
	NOP
	BEQZ R5 LOOP_FIN
	NOP
	
PIKA_UPPRE1:
	NOP
	B PIKA_UPPRE2
	NOP
	
	
SCENE_MOVE:
	LI R2 0X0000 ;从第0列起 读取MEM(R4+R2)的内容，高8位为上界，低8位为下界
	ADDIU R4 0X0001 ;场景向后刷新1列
	
	SCENE_COL_LOOP:
	
		CMPI R2 0X0050
		NOP
		BTEQZ SCENE_END ;80列 跳出循环
		NOP
		
		LI R1 0X0000
		LI R0 0X0000
		SCENE_FLUSH_LOOP:
			CMPI R1 0X001E
			NOP
			BTEQZ SCENE_FLUSH_END
			NOP
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			NOP
			SW R6 R0 0X0003
			ADDIU R1 0X0001
			NOP
			B SCENE_FLUSH_LOOP
			NOP
			
		SCENE_FLUSH_END:
		
		ADDU R2 R4 R7 ;R7为当前列在RAM1中对应的数据地址
		LW R7 R0 0X0000
		SRA	R0 R0 0X0000
		LI R6 0X00FF
		AND R0 R6 ;R0为障碍上界位置
		LI R1 0x0000
			SCENE_LOW_LOOP:
			CMP R1 R0 
			NOP
			BTEQZ SCENE_LOW_END
			NOP
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			
			LI R7 0X00E8
			SW R6 R7 0X0003
			ADDIU R1 0X0001
			NOP
			B SCENE_LOW_LOOP
			NOP
		
		SCENE_LOW_END:
		ADDU R2 R4 R7
		LW R7 R0 0X0000
		LI R6 0X00FF
		AND R0 R6 ;R0为障碍下界位置
		ADDIU3 R0 R1 0X0000 ;R1 <= R0
			SCENE_HIGH_LOOP:
			CMPI R1 0X001E
			NOP
			BTEQZ SCENE_HIGH_END
			NOP
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			
			LI R7 0X00E8
			SW R6 R7 0X0003
			ADDIU R1 0X0001
			NOP
			B SCENE_HIGH_LOOP
			NOP
		
	SCENE_HIGH_END:	
	ADDIU R2 0X0001	
	NOP
	B SCENE_COL_LOOP
	NOP

PIKA_DOWNPRE2:
	NOP
	B PIKA_DOWN
	NOP
	
PIKA_UPPRE2:
	NOP
	B PIKA_UP
	NOP
	
PIKA_DOWN:	
	;清除PIKA最上面一行
	ADDIU3 R3 R1 0X0000 ;R1 <= R3
	LI R2 0X0014 ;PIKA col [14,1C)
	LI R0 0X0000
	
		PIKA_DOWN_PRE_LOOP:
		CMPI R2 0X001C
		NOP
		BTEQZ PIKA_DOWN_START
		NOP
		SLL R7 R1 0X0000
		OR R7 R2
		LI R6 0X00BF
		SLL R6 R6 0X0000
		ADDIU R6 0X000A
		SW R6 R7 0X0000
		NOP
		SW R6 R0 0X0003
		ADDIU R2 0X0001
		NOP
		B PIKA_DOWN_PRE_LOOP
		NOP
	
	PIKA_DOWN_START:
	ADDIU R3 0X0001 ;PIKA 下移
	MTIH R3 ;储存R3
	ADDIU3 R3 R1 0X0000 ;R1 <= R3
	ADDIU R3 0X0004 ;
	LI R0 0X00C8 ;PIKA Data start
	
		PIKA_DOWN_ROW_LOOP:
		CMP R1 R3
		NOP
		BTEQZ PIKA_DOWN_ROW_END
		NOP
		LI R2 0X0014
			
			PIKA_DOWN_COL_LOOP:
			CMPI R2 0X001C
			NOP
			BTEQZ PIKA_DOWN_COL_END
			
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			NOP
			SW R6 R0 0X0003
			
			ADDIU R0 0X0001
			ADDIU R2 0X0001
			NOP
			B PIKA_DOWN_COL_LOOP
			NOP
			
		PIKA_DOWN_COL_END:
		ADDIU R1 0X0001
		NOP
		B PIKA_DOWN_ROW_LOOP
		NOP
		
	PIKA_DOWN_ROW_END:
	MFIH R3 ;恢复R3
	NOP
	B PIKA_DOWN_END
	NOP

PIKA_UP:	
	ADDIU3 R3 R1 0X0003 ;R1 <= R3 + 3
	LI R2 0X0014 ;PIKA col [14,1C)
	LI R0 0X0000
	
		PIKA_UP1_PRE_LOOP:
		CMPI R2 0X001C
		NOP
		BTEQZ PIKA_UP1_START
		NOP
		SLL R7 R1 0X0000
		OR R7 R2
		LI R6 0X00BF
		SLL R6 R6 0X0000
		ADDIU R6 0X000A
		SW R6 R7 0X0000
		NOP
		SW R6 R0 0X0003
		ADDIU R2 0X0001
		NOP
		B PIKA_UP1_PRE_LOOP
		NOP
	
	PIKA_UP1_START:
	ADDIU R3 0XFFFF ;PIKA 上移
	MTIH R3 ;储存R3
	ADDIU3 R3 R1 0X0000 ;R1 <= R3
	ADDIU R3 0X0004 ;
	LI R0 0X00C8 ;PIKA Data start
	
		PIKA_UP1_ROW_LOOP:
		CMP R1 R3
		NOP
		BTEQZ PIKA_UP1_ROW_END
		NOP
		LI R2 0X0014
			
			PIKA_UP1_COL_LOOP:
			CMPI R2 0X001C
			NOP
			BTEQZ PIKA_UP1_COL_END
			
			SLL R7 R1 0X0000
			OR R7 R2
			LI R6 0X00BF
			SLL R6 R6 0X0000
			ADDIU R6 0X000A
			SW R6 R7 0X0000
			NOP
			SW R6 R0 0X0003
			
			ADDIU R0 0X0001
			ADDIU R2 0X0001
			NOP
			B PIKA_UP1_COL_LOOP
			NOP
			
		PIKA_UP1_COL_END:
		ADDIU R1 0X0001
		NOP
		B PIKA_UP1_ROW_LOOP
		NOP
		
	PIKA_UP1_ROW_END:
	MFIH R3 ;恢复R3
	NOP
	B PIKA_UP_END
	NOP